ArticleEditor.add("plugin","reorder",{defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><g fill="#000" fill-rule="nonzero"><path d="m13 5c.5522847 0 1 .44771525 1 1 0 .51283584-.3860402.93550716-.8833789.99327227l-.1166211.00672773h-10c-.55228475 0-1-.44771525-1-1 0-.51283584.38604019-.93550716.88337887-.99327227l.11662113-.00672773z"/><path d="m13 9c.5522847 0 1 .44771525 1 1 0 .5128358-.3860402.9355072-.8833789.9932723l-.1166211.0067277h-10c-.55228475 0-1-.4477153-1-1 0-.51283584.38604019-.93550716.88337887-.99327227l.11662113-.00672773z"/></g></svg>'},subscribe:{"block.set":function(){this._observe()}},init:function(){},start:function(){this.app.control.add("reorder",{icon:this.opts.reorder.icon,position:"first",blocks:{all:"first-level"}})},stop:function(){this._stopEvents()},_observe:function(){this.$btn=this.app.control.get("reorder"),0!==this.$btn.length&&(this.$btn.addClass(this.prefix+"-handle"),this._sortable())},_sortable:function(){this.instance=this.app.block.get(),this.$win=this.app.editor.getWin(),this.tolerance=this.$btn.width(),this.$clickItem=null,this.$dragItem=null,this.oldY=0,this.dragging=!1,this.$btn.on("mousedown."+this.prefix+"-reorder touchstart."+this.prefix+"-reorder",this._press.bind(this))},_press:function(t){var i=this.dom(t.target).closest("."+this.prefix+"-button");t&&t.target&&i.hasClass(this.prefix+"-handle")&&(t.preventDefault(),this.app.observer.trigger=!1,this.$win.on("mouseup."+this.prefix+"-reorder touchend."+this.prefix+"-reorder",this._release.bind(this)),this.$win.on("mousemove."+this.prefix+"-reorder touchmove."+this.prefix+"-reorder",this._move.bind(this)),i=this.instance.getBlock().get(),this.app.block.unset(),this.dragging=!0,this.$dragItem=this._makeDragItem(i,t.target))},_release:function(t){this._stopEvents(),this.app.observer.trigger=!0,this.oldY=0,this.dragging=!1,this._trashDragItem(),this.app.block.set(this.instance)},_move:function(t){if(this.$dragItem||this.dragging){t.preventDefault();var i=this.app.editor.getFrameRect(),e=!1,s=0===this.oldY?0:this.oldY-t.pageY,r=(0<s?e="up":s<0&&(e="down"),this.app.scroll.isTarget()),o=this._isFrameScroll(),h=this.app.$doc.scrollTop(),a=r?this.app.scroll.getTarget():this.app.$doc,p=(o?this.app.editor.getDoc():a).scrollTop();this._moveItem(this.$dragItem,s),this.oldY=t.pageY;for(var n,s=!1,r=(r?n=a.height()+a.offset().top-40:o?(n=i.bottom-40,(endWin=this.app.$win.height()+h-40)<n&&(n=endWin)):(s=!this.app.toolbar.isSticky(),n=this.app.$win.height()+p-40),this.app.container.get("bars")),a=r.height(),h=o?t.pageY+i.top-p:t.pageY+i.top,o=r.offset().top+a+40,l=("up"===e&&0<p&&h<o&&!1===s?this._scroll(-10):"down"===e&&n<h&&this._scroll(10),this.app.editor.getLayout().children()),c=l.length,d=0;d<c;d++){var g=l.eq(d).get();g!==this.$clickItem.get()&&this._isOver(this.dom(g))&&this._swapItems(g)}}},_scroll:function(t){var i=this.app.scroll.isTarget()?this.app.scroll.getTarget():this.app.$win,e=(i=this._isFrameScroll()?this.app.editor.getWin():i).scrollTop();i.scrollTop(e+t)},_swapItems:function(t){var i=this.$dragItem.offset().top,e=this.$clickItem,t=this.dom(t),s=t.offset(),r=t.height()/2;t[r+s.top>i?"before":"after"](e)},_stopEvents:function(){this.$win&&(this.$btn.off("."+this.prefix+"-reorder"),this.$win.off("."+this.prefix+"-reorder"))},_isFrameScroll:function(){return this.app.editor.getFrame().height()<this.app.editor.getBody().height()},_isOver:function(t){var i=this.$dragItem.offset().top,e=t.offset(),t=t.height();return i>e.top&&i<e.top+t},_moveItem:function(t,i){var e=t.offset().top;t.css("top",(e-=i)+"px")},_makeDragItem:function(t){this._trashDragItem();var t=this.dom(t),i=t.offset(),e=(this.$clickItem=t,this.$clickItem.addClass(this.prefix+"-drag-active"),t.clone()),s=(e.removeClass(this.prefix+"-drag-active "+this.prefix+"-element-active"),this.dom("<div>").addClass(this.prefix+"-dragging"));return s.append(e),s.css({opacity:.95,position:"absolute","z-index":999,left:i.left+"px",top:i.top+"px",width:t.width()+"px"}),this.app.editor.getBody().append(s),s},_trashDragItem:function(){this.$dragItem&&this.$clickItem&&(this.$clickItem.removeClass(this.prefix+"-drag-active"),this.$clickItem=null,this.$dragItem.remove(),this.$dragItem=null)}});